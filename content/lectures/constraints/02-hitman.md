---
title: 2. Метод Hitman Codename 47
author: Роман Козак
type: docs
math: true
toc: true
sidebar:
  open: true
---

## Интро

Это супер крутой метод, который придумали в 2000 году разработчики игры Hitman: Codename 47. Сейчас он мало где используется, но он очень простой и интуитивно понятный. К тому же другой метод который уже используется (XPBD) во многом похож на него.

Hitman: Codename 47 — одна из первых игр, использовавших "кукольную"\  (ragdoll) физику, а не готовые анимации для смерти врагов.
За основу физического движка был взят ванильный интегратор Верле и релаксацию ограничений.
Напомню, что численная схема интегратора Верле выглядит так:
$$
\begin{equation}
x(t + \Delta t) = 2x(t) + x(t - \Delta t) + a(t)\Delta t^2 + O(\Delta t^4)
\end{equation}
$$

Как уже говорилось, в нем нет скоростей в явном виде. 

Релаксация ограничений -- это этап в котором ограничения на позиции и скорости точек вычисляются и исправляются.

И физический движок сначала вычисляет новые позиции точек с помощью Верле и потом запускает релаксацию.

## Релаксация

Идея релаксации очень простая. Когда какие-то позиции не удовлетворяют ограничениям, мы их просто сдвигаем так, чтобы ограничения выполнялись. Вопрос в том. как это правильно делать.

### Пример

Сначала разберемся с релаксацией на простых примерах.
Вот есть две точки, которые должны быть на расстоянии $d$ друг от друга.

{{< image path="images/constraints/hitman/stretch.excalidraw.png" >}}

Ограничение на сохранение расстояния между двумя точками:

$$
\begin{equation}
C(p_1, p_2) = |p_2 - p_1| - d = 0
\end{equation}
$$

В какой-то момент симуляции мы получаем плохую ситуация с растянутым ограничением. Точки оказались дальше, чем нужно.
В таком случае релаксация должна стянуть точки к друг другу чтобы выполнить ограничение. Мы можем удовлетворить это ограничение множеством способов, поэтому нужно ввести дополнительные условия: Смещение должно быть минимальным в направлении к центру масс. Поэтому логично смещать точки друг к другу. В оригинальной статье еще не было математического обоснования для такого выбора, авторы действовали интуитивно. Позднее в статье о XPBD будет более строгое обоснование.
<br>
Для точек с одинаковой массой можно каждую сместить на половину сдвига:
$$
\begin{equation}
\begin{split}
&p_1' = p_1 - \frac{1}{2}\Delta d \\\
&p_2' = p_2 + \frac{1}{2}\Delta d
\end{split}
\end{equation}
$$

{{< image  path="images/constraints/hitman/stretch_relax.excalidraw.png" >}}

Для точек с разной массой можно каждую сместить на величину, обратно пропорциональную массе:
$$
\begin{equation}
\begin{split}
&p_1' = p_1 - \frac{m_2}{m_1 + m_2}\Delta x \\\
&p_2' = p_2 + \frac{m_1}{m_1 + m_2}\Delta x
\end{split}
\end{equation}
$$
для того чтобы тело с большей массой было более инертным и смещалось меньше.

### Обобщаем

Теперь попробуем обобщить этот метод на случай, когда у нас несколько точек и несколько ограничений.
Вот 4 материальные точки и 6 ограничений, некоторые растянуты, некоторые сжаты.
{{< image  path="images/constraints/hitman/many_delta.excalidraw.png" >}}

Мы не умеем решать такую систему с несколькими точками, но нам это и не нужно. Оказывается если разрешать ограничения по одному несколько раз, то получается хороший результат.

пытаться решать задачу в таком виде, то она может оказаться сложной и занимать много вычислительных ресурсов, поэтому использовался хитрый прием: вместо обработки всех ограничений разом они обрабатывались по очереди, т.е. результат обработки ограничения подавался на вход обработки следующего ограничения, и так повторяем до тех пор, пока все ограничения не удовлетворены или не закончится время на до следующего тика физики. Таким образом можно добиваться разной точности в разных ситуациях и менять её на лету. Такой метод называется релаксацией.

Интересным результатом этого является то, что если мы проводим эту релаксацию не до конца, а лишь определенное число раз, то этот метод хорошо выглядящую симуляцию тканей и мягких тел. Ошибка в ограничении на длины дает эффект небольшого растяжения тканей или тел; более того, если разрушать связи при большом отличии от ограничения, можно получать реалистичные разрывы в ткани.

### Разрешение коллизий
Ограничение на непроникновение твердого тела в другое тело:
$$
\begin{equation}
x\cdot n < a \Leftrightarrow x\cdot n - a < 0
\end{equation}
$$

Описанный метод работает с точками. Однако когда мы пытаемся симулировать твердые тела как набор материальных точек, связанных ограничениями, могут случаться ошибки этого приближения. Одна из самых распространенных - проникновение частей одного твердого тела в другое. Так как тело представлено ограниченным набором точек, может случиться такое, что для всех точек все ограничения выполнены, но часть точек одного предмета оказалась внутри объема другого (ведь при такой симуляции у нас нет поверхности предмета, а скорее его скелет). Нам нужно ввести способ разрешать не только коллизии точек, но и поверхностей.
Изобразим описанную ситуацию на диаграмме:
\input{pics/pen.tex}
Предположим, что мы знаем, что коллизия произошла (как именно это может быть реализовано будет рассмотрено отдельно на более поздних лекциях). В этом случае снова хочется на уровне позиций вытолкнуть одно тело из другого.

Предлагается следующее решение: так как мы работаем с отрезками и/или поверхностями, координаты всех точек на них можно выразить как линейные комбинации вершин, т.е. материальных точек. Тогда при засеченной коллизии мы можем добавить новое ограничение на линейную комбинацию координат, доставляющее условию непроникновения одного тела в другое, после чего мы можем использовать всю методологию, описанную выше.

Для большей понятности опишем этот процесс для приведенного примера: нами засечена коллизия, точка $p$ находится внутри твердого тела. Мы хотим вытолкнуть его так, чтобы новая позиция $p'$ совпала с точкой $q$.

Выразим $p$ как линейную комбинацию вершин отрезка:
$$
\begin{equation}
\begin{split}
&p = \alpha x_1 + (1 - \alpha)x_2 \\\
&p'= \alpha x'_1 + (1 - \alpha)x'_2 = q
\end{split}
\end{equation}
$$

Тогда принимая желаемое положение за ограничение, можно получить новые позиции (тут мы считаем, что массы равны, и на размер сдвига влияет только положение точек):
$$
\begin{equation}
\begin{split}
&x'_1 = x_1 + \lambda\alpha(q - p) \\\
&x'_1 = x_1 + \lambda(1 -\alpha)(q - p) \\\
&\lambda = (\alpha^2 + (1 - \alpha)^2)^{-1}
\end{split}
\end{equation}
$$
### Трение

Как известно из курса школьной физики, сила трения прямо пропорциональна силе реакции опоры. В этом же случае вместо того, чтобы высчитывать эту силу, была использована глубина проникновения одного тела в другое.
\subsubsection{Приближение корня.}
Известно, что точное вычисление квадратного корня - операция затратная. Когда мы говорили о сохранении расстояний между точками, то мы высчитывали длину отрезков - а это по теореме Пифагора потребует корня. Учитывая то, что за время релаксации подсчет будет происходит множество раз, было решено для каждой такой длины брать не честный корень, а разложение в ряд Тейлора вокруг длины в нерастянутом состоянии до первого члена. Таким образом можно сэкономить вычислительные ресурсы, не сильно тратя в точности, ведь мы так или иначе считаем эти вещи множество раз за время релаксации, постепенно приближаясь к аналитически верному решению.

## Источники

[Оригинальная статья от разработчика](https://www.cs.cmu.edu/afs/cs/academic/class/15462-s13/www/lec_slides/Jakobsen.pdf)