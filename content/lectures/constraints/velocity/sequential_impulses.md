---
title: 10. Sequential Impulses
author: Роман Козак
type: docs
weight: 10
math: true
toc: true
sidebar:
  open: true
---





Теперь давайте попробуем реализовать наше любимое ограничение на дистанцию.

Пусть это будет ограничения на дистанцию точки от подвеса.

$$
C(x) = \|x - x_0\|^2 - r^2 = 0
$$

Если продифференцировать это ограничение по времени, то получим скорость точки в направлении ограничения.

$$
\dot{C}(x) = 2(x - x_0) \cdot \dot{x} = 0
$$

Для нас это означает, что проекция скорости точки на вектор от точки до подвеса должна быть равна нулю.

$$
v_{\parallel} = (x - x_0) \cdot \dot{x} = 0
$$

Или, что скорость точки должна быть перпендикулярна вектору от точки до подвеса.

{{< image path="images/constraints/sequential_impulses/pendulum_velocity.excalidraw.png" >}}

Если скорость всегда будет перпендикулярна вектору от точки до подвеса, то ограничение на дистанцию будет удовлетворено.

Симулируем...
{{< include_sketch path="constraints/sketch/impulses_pendulum.js" base_name="impulses_pendulum" >}}

И ничего не получилось. Это происхожит потому что мы не можем изменять скорость непрерывно. Мы делаем это дискретно, появляется ошибка и она накапливается.

###  Baumgarte Stabilization

У нас появилась дополнительная задача -- помимо удовлетворения ограничения, нам нужно еще и следить за тем, чтобы ошибка не накапливалась.
Для этого мы можем использовать метод Баумгартена.
Если изначально мы пытались удовлетворить производной ограничения $$\dot{C}(x) = 0$$, то теперь мы будем пытаться удовлетворить ограничение с некоторым запасом чтобы убирать накопившуюся ошибку.

$$
\dot{C}(x) + \lambda \cdot C(x) = 0
$$

Где $\lambda$ -- это некоторый коэффициент, который мы можем менять. Чем больше $\lambda$, тем быстрее ошибка будет сходить на нет.

Давайте сразу просимулируем двойной маятник.

{{< include_sketch path="constraints/sketch/baumgarte_double_impulses.js" base_name="baumgarte_double_impulses" >}}

Если $\lambda$ слишком большой, то при большой ошибке, мы можем получить слишком большую скорость. Это особенно хорошо заметно в симуляциях с коллизиями, когда один объект глубоко проникает в другой. То он вылетает с большой скоростью.

Такой подход использовался в старой версии Box2D, но потом его убрали.

В Движке ODE это называется ERP (ERP - Error Reduction Parameter)
[Пуньк](<https://ode.org/wiki/index.php/Manual#Soft_constraint_and_Constraint_Force_Mixing_(CFM)>)

### NGS

