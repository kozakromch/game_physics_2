---
title: 1. Численные методы
author: Роман Козак
credential: { Петров Степан }
type: docs
toc: true
math: true
---

{{< add_script "js/numerical_method/3_body.js" >}}
{{< add_script "js/numerical_method/canon.js" >}}
{{< add_script "js/numerical_method/spring.js" >}}



## Интро

То ли мы глупые то ли вселенная такая несовершенная,
но многие дифуры невозможно решить аналитически.
Меня например удивляет, что задача трех тел уже не разрешима
Но с другой стороны если такие траектории можно описать аналитичеки, то это было бы очень круто.
Вы только взгляните, какая красота

{{% include_sketch path="numerical_method/sketch/3_body_sketch.js" base_name="three_body_sketch"%}}

В играх приходится иметь дело с системами гораздо сложнее чем взаимодействие трех тел,
которые тоже врядли получится решить аналитически.
Поэтому много умных людей разработали более универсальные методы -- численные.
Базовая идея -- имея начальную точку получаем
Они дают лишь одно решение в то время как аналитический метод дает все решения.
Но в большинстве случаев нам только одно и нужно. В игре уже есть начальное состояние,
и мы просто хотим узнать что будет дальше.


Стоит сказать, что все счастливые семьи, в которых все уравнения решаются аналитически, похожи друг на друга, они просто подставляют в решение время и получают все, что нужно. Несчастливая семья же несчастна по своему. Одни разработчики симулируют только частицы , другие только твердые тела. Кому-то очень важна точность, а кому-то нужно чтобы просто было стабильно и хоть немножко похоже на правду. Тут нет правильного рецепта, каждый страдает в мерру своих ограничений.

Здесь я попробую рассказать о самых популярных и используемых методах численного интегрирования.


## Необходимые знания

### Фазовое пространство

Помимо основных знаний о дифурах, для понимания дальше написаного нужно знать, что такое фазовое пространство.
Формальное определение:

> "Фазовое пространство -- это пространство, четной размерности, 
> координатами в котором являются обычные пространственные координаты (или обобщённые координаты) частиц системы и их импульсы"



Нам же достаточно понимать малую часть от этого -- для одномерной системы, например пружинки которая может колебаться по одной оси, фазовое пространство -- это график, где на одной оси у нас координата, а на другой импульс и точка на этом графике -- это состояние системы.

{{< image path="images/numerical_method/phase_space_spring.excalidraw.png" >}}

Если же пружинка может колебаться в двух направлениях, то фазовое пространство будет четырехмерным -- импульсы и координаты по двум направлениям.


### Векторные поля

Еще очень полезно и приятно рисовать векторные поля системы на фазовом пространстве. Векторное поле -- это набор векторов, каждый из которых показывает направление и скорость изменения в каждой точке фазового пространства.
Вот так будет выглядеть фазовое пространство для пружинки:

{{< image  path="images/numerical_method/phase_trajectory.excalidraw.png" >}}


## Модельные задача

Для того чтобы анализировать численные методы возьмем простые задачи, 
которые достаточно часто встречаются в играх и для которых известно аналитическое решение. Для того чтобы решить систему численно, нужно переписать уравнение в виде системы уравнений первого порядка.

### Стрельба из пушки

{{< image path="images/numerical_method/canon.excalidraw.png" >}}

Тело массой $m$ вылетает из пушки с начальной скоростью $v_0$ под углом $\alpha$ к горизонту.
{{<details title="Формальности" closed="true" >}}
Тогда уравнение движения примет вид

$$
\begin{equation*}
\begin{split}
\ddot{x} = 0,\\\
\ddot{y} = -g,
\end{split}
\end{equation*}
$$

где $g$ - ускорение свободного падения. Перепишем уравнение в виде
$$
\begin{equation*}
\begin{split}
&\dot{x} = v_x,\\\
&\dot{v_x} = 0,\\\
&\dot{y} = v_y,\\\
&\dot{v_y} = -g.
\end{split}
\end{equation*}
$$
Если ввести вектор состояния $z$:
$$
\begin{equation*}
    z =
     \begin{bmatrix}     x \\\     v_x \\\     y \\\     v_y \\\     \end{bmatrix}
\end{equation*}
$$
и константный вектор $G$:
$$
\begin{equation*}
    G = \begin{bmatrix} 0 \\\ 0 \\\ 0\\\ -g \end{bmatrix}
\end{equation*}
$$
Тогда уравнение перепишем в виде
$$
\begin{equation*}
    \dot{z} =
    \begin{bmatrix}
        0 & 1 & 0 & 0 \\\
        0 & 0 & 0 & 0 \\\
        0 & 0 & 0 & 1 \\\
        0 & 0 & 0 & 0 \\\
    \end{bmatrix}
    \cdot z  + \begin{bmatrix} 0 \\\ 0 \\\ 0\\\ -g \end{bmatrix} = A \cdot z + G
\end{equation*}
$$
{{< /details >}}

Аналитическое решение этой задачи -- обычная баллистическая кривая.
$$
\begin{equation}
    \begin{split}
        &x(t) = v_0 t \cos(\alpha) \\\ 
        &y(t) = v_0 t \sin(\alpha) - \frac{1}{2}gt^2.
    \end{split}
\end{equation}
$$

{{< include_sketch path="numerical_method/sketch/analitical_canon.js" base_name="analitical_canon" >}}


### Пружинка

Пружинка с коэффициентом жесткости $k$, массой $m$ и начальным смещением $x_0$  и начальной скоростью $v_0$.

{{< image  path="images/numerical_method/spring.excalidraw.png" >}}
{{<details title="Формальности" closed="true" >}}
$$
\ddot{x} = -\frac{k}{m}x,\\
$$
Тогда уравнение движения примет вид
$$
\begin{equation*}
    \begin{split}
        &\dot{x} = v,\\\
        &\dot{v} = -\frac{k}{m}x.
    \end{split}
\end{equation*}
$$
Аналогично
$$
\begin{equation*}
    z =
     \begin{bmatrix}     x \\     v \\     \end{bmatrix}
\end{equation*}
$$
Тогда уравнение перепишем в виде
$$
\begin{equation*}
    \dot{z} =
    \begin{bmatrix}
        0 & 1 \\
        -\frac{k}{m} & 0 \\
    \end{bmatrix}
    \cdot z = A \cdot z
\end{equation*}
$$
{{< /details >}}

Аналитическое решение для этой задачи -- гармонические колебания.
$$
\begin{equation}
    x(t) = (x_0\cos(\omega t) + v_0\sin(\omega t)),
\end{equation}
$$

{{< include_sketch path="numerical_method/sketch/analitical_spring.js" base_name="analitical_spring" >}}

